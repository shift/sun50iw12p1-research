#!/bin/sh
# HY300 U-Boot Boot Script - USB Serial Console Support
# This script enables USB gadget CDC ACM for serial console access via USB
# Compile with: mkimage -C none -A arm -T script -d hy300_boot_usb_serial.txt boot.scr

echo "HY300 U-Boot - Initializing USB Serial Console"

# Initialize USB subsystem
usb start

# Start USB gadget in CDC ACM (serial) mode
# This makes the device appear as /dev/ttyACM0 on the host
echo "Enabling USB CDC ACM serial gadget..."
ums 0 mmc 0

# Configure console output to both UART and USB serial
# This allows dual console access: physical UART + USB serial
setenv stdout serial,usbacm
setenv stderr serial,usbacm
setenv stdin serial,usbacm

echo "USB Serial Console: /dev/ttyACM0 on host"
echo "Dual console active: UART0 + USB CDC ACM"

# Continue normal boot process
# Boot from eMMC if available
if mmc dev 0; then
    echo "eMMC detected, attempting boot..."
    if load mmc 0:1 ${kernel_addr_r} /boot/Image; then
        if load mmc 0:1 ${fdt_addr_r} /boot/dtbs/allwinner/sun50i-h713-hy300.dtb; then
            echo "Booting Linux kernel with USB serial console..."
            booti ${kernel_addr_r} - ${fdt_addr_r}
        fi
    fi
fi

# Fallback: Drop to U-Boot shell with USB serial console active
echo "Boot failed, dropping to U-Boot shell"
echo "Console available on both UART and USB serial"
